"0","# Prepare gene annotation ranges "
"0","genes4gwas <- pcod.gtf %>% mutate(ncbi_id=paste0(""GeneID:"", ncbi_id)) %>% "
"0","  filter(feature==""gene"") %>% "
"0","  mutate(start_flank=start-2000) %>%"
"0","  mutate(start_flank=as.integer(case_when(start_flank<0~0, TRUE~start_flank))) #%>% "
"0",""
"0","gene_ranges <- GRanges("
"0","  seqnames =genes4gwas$seqname,"
"0","  ranges=IRanges("
"0","  start=genes4gwas$start_flank,"
"0","#  start = genes4gwas$start,"
"0","  end=genes4gwas$end),"
"0","  ncbi_id=genes4gwas$ncbi_id,"
"0","  gene_id=genes4gwas$gene_id)"
"0",""
"0","# Prepare putative sex marker sites locations "
"0","sex.sites <- lrt_filt %>% mutate(logp=-log10(pvalue)) %>% filter(logp>4) %>% mutate(marker=paste0(Chromosome, ""_"", Position))"
"0",""
"0","snp_ranges <- GRanges("
"0","  seqnames = sex.sites$Chromosome,"
"0","  ranges=IRanges("
"0","    start = sex.sites$Position,"
"0","    end = sex.sites$Position),"
"0","  pvalue=sex.sites$pvalue,"
"0","  Major=sex.sites$Major,"
"0","  Minor=sex.sites$Minor)"
"0",""
"0","# Find overlaps between gene flanks and SNP sites"
"0","overlaps <- findOverlaps(gene_ranges, snp_ranges)"
"0",""
"0","# Extract matching rows"
"0","overlapping_genes <- genes4gwas[queryHits(overlaps), ]"
"0","overlapping_snps <- sex.sites[subjectHits(overlaps), ]"
"0",""
"0","# Combine results into a single data frame"
"0","result <- cbind(overlapping_genes, overlapping_snps) %>% "
"0","  mutate(feature=case_when(Position>=start~""gene"", Position<start~""upstream"")) %>% "
"0","  dplyr::select(-c(score, frame, attributes,biotype, exon)) %>% "
"0","#  dplyr::select(feature, seqname, strand, start_flank, start, end, Position, gene_id, ncbi_id, gene_id) %>% "
"0","  left_join(pcod.blast.GO[c(""ncbi_id"", ""protein_names"", ""spid"")] %>% mutate(ncbi_id=paste0(""GeneID:"", ncbi_id)), by=""ncbi_id"")"
"0",""
"0","# what percent of SNPs are located inside "
"0","result %>% dplyr::select(-Position) %>% distinct() %>% group_by(feature) %>%  tally() %>% "
"0","  mutate(total=nrow(genes4gwas)) %>% mutate(perc=round(100*n/total, 2))"
